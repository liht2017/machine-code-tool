name: è·¨å¹³å°æ„å»º

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v2.1.0)'
        required: false
        default: 'latest'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: machine-code-tool.exe
            asset_name: machine-code-tool-windows.exe
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: machine-code-tool
            asset_name: machine-code-tool-macos-intel
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: machine-code-tool
            asset_name: machine-code-tool-macos-arm
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: machine-code-tool
            asset_name: machine-code-tool-kylin

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: å®‰è£…Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: ${{ matrix.target }}

    - name: ç¼“å­˜Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          src-tauri/target
        key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.target }}-
          ${{ runner.os }}-cargo-

    - name: å®‰è£…Linuxä¾èµ–
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        # Try webkit2gtk-4.1 first (Ubuntu 24.04+), fallback to 4.0 (older versions)
        sudo apt-get install -y libwebkit2gtk-4.1-dev || sudo apt-get install -y libwebkit2gtk-4.0-dev
        sudo apt-get install -y build-essential curl wget libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev

    - name: å®‰è£…Tauri CLI
      run: cargo install tauri-cli

    - name: æ„å»º
      run: |
        cd src-tauri
        cargo tauri build --target ${{ matrix.target }}

    - name: æŸ¥æ‰¾æ„å»ºæ–‡ä»¶
      run: |
        echo "æŸ¥æ‰¾æ„å»ºäº§ç‰©..."
        find src-tauri/target -name "machine-code-tool*" -type f || true
        ls -la src-tauri/target/${{ matrix.target }}/release/ || true
      shell: bash

    - name: å¤åˆ¶å¹¶é‡å‘½åæ„å»ºäº§ç‰©
      run: |
        mkdir -p upload
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          # Windows: ç›´æ¥å¤åˆ¶exeæ–‡ä»¶
          cp src-tauri/target/${{ matrix.target }}/release/machine-code-tool.exe upload/${{ matrix.asset_name }}
        else
          # macOS/Linux: å¤åˆ¶æ–‡ä»¶å¹¶æ·»åŠ æ‰§è¡Œæƒé™
          cp src-tauri/target/${{ matrix.target }}/release/machine-code-tool upload/${{ matrix.asset_name }}
          chmod +x upload/${{ matrix.asset_name }}
          
          # ä¸ºmacOSåˆ›å»º.appåº”ç”¨åŒ…ï¼Œå¯ç›´æ¥åŒå‡»è¿è¡Œ
          if [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            APP_NAME="${{ matrix.asset_name }}.app"
            mkdir -p "upload/$APP_NAME/Contents/MacOS"
            mkdir -p "upload/$APP_NAME/Contents/Resources"
            
            # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶åˆ°appåŒ…å†…
            cp "upload/${{ matrix.asset_name }}" "upload/$APP_NAME/Contents/MacOS/machine-code-tool"
            chmod +x "upload/$APP_NAME/Contents/MacOS/machine-code-tool"
            
            # åˆ›å»ºInfo.plist
            cat > "upload/$APP_NAME/Contents/Info.plist" << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleExecutable</key>
    <string>machine-code-tool</string>
    <key>CFBundleIdentifier</key>
    <string>com.xinyu.machine-code-tool</string>
    <key>CFBundleName</key>
    <string>æœºå™¨ç è·å–å·¥å…·</string>
    <key>CFBundleDisplayName</key>
    <string>æœºå™¨ç è·å–å·¥å…·</string>
    <key>CFBundleVersion</key>
    <string>2.1.0</string>
    <key>CFBundleShortVersionString</key>
    <string>2.1.0</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>LSMinimumSystemVersion</key>
    <string>10.13</string>
    <key>NSHighResolutionCapable</key>
    <true/>
    <key>LSUIElement</key>
    <false/>
</dict>
</plist>
EOF
            
            echo "âœ… å·²åˆ›å»ºmacOSåº”ç”¨åŒ…: $APP_NAME"
            ls -la "upload/$APP_NAME/Contents/MacOS/"
          fi
        fi
        ls -la upload/
      shell: bash

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.asset_name }}
        path: upload/

  collect:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        pattern: machine-code-tool-*
        merge-multiple: true
      
    - name: æ•´ç†æ–‡ä»¶å¹¶æ·»åŠ æ­£ç¡®æ‰©å±•å
      run: |
        mkdir -p release
        
        echo "å½“å‰ç›®å½•æ–‡ä»¶:"
        ls -la
        
        # å¤„ç†æ‰€æœ‰ä¸‹è½½çš„æ–‡ä»¶
        for file in machine-code-tool-*; do
          if [ -f "$file" ]; then
            echo "å¤„ç†æ–‡ä»¶: $file"
            cp "$file" "release/$file"
            chmod +x "release/$file"
          fi
        done
        
        # åˆ›å»ºä½¿ç”¨è¯´æ˜
        cat > release/README.txt << 'EOF'
        ğŸš€ æœºå™¨ç è·å–å·¥å…· - ä½¿ç”¨è¯´æ˜
        ================================
        
        ğŸ“¦ æ–‡ä»¶è¯´æ˜:
        - machine-code-tool-windows.exe  â†’ Windowsç³»ç»Ÿ (åŒå‡»è¿è¡Œ)
        - machine-code-tool-macos-intel  â†’ Intel Mac (ç»ˆç«¯: ./machine-code-tool-macos-intel)  
        - machine-code-tool-macos-arm    â†’ Apple Silicon Mac (ç»ˆç«¯: ./machine-code-tool-macos-arm)
        - machine-code-tool-kylin        â†’ é“¶æ²³éº’éºŸç³»ç»Ÿ (ç»ˆç«¯: ./machine-code-tool-kylin)
        
        ğŸŒ è®¿é—®ç•Œé¢:
        ç¨‹åºå¯åŠ¨åï¼Œæ‰“å¼€æµè§ˆå™¨è®¿é—®: http://localhost:3030
        
        ğŸ“‹ APIæ¥å£:
        - GET  /api/machine-code  â†’ è·å–æœºå™¨ç 
        - GET  /api/auth-status   â†’ æ£€æŸ¥æˆæƒçŠ¶æ€
        - POST /api/set-auth      â†’ è®¾ç½®æˆæƒçŠ¶æ€
        
        âš ï¸  macOSå®‰å…¨æç¤º:
        å¦‚æœæç¤º"æ— æ³•éªŒè¯å¼€å‘è€…"ï¼Œè¯·åˆ° ç³»ç»Ÿåå¥½è®¾ç½® â†’ å®‰å…¨æ€§ä¸éšç§ â†’ ç‚¹å‡»"ä»è¦æ‰“å¼€"
        EOF
        
        ls -la release/
        
    - name: ä¸Šä¼ æœ€ç»ˆäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: all-platforms-${{ github.run_number }}
        path: release/
        
    - name: åˆ›å»ºRelease (ä»…æ ‡ç­¾æ¨é€æ—¶)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: release/*
        name: æœºå™¨ç è·å–å·¥å…· ${{ github.ref_name }}
        body: |
          ## ğŸš€ æœºå™¨ç è·å–å·¥å…· ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½é“¾æ¥
          - **Windows**: machine-code-tool-windows.exe
          - **macOS Intel**: machine-code-tool-macos-intel  
          - **macOS ARM**: machine-code-tool-macos-arm
          - **é“¶æ²³éº’éºŸ**: machine-code-tool-kylin
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - è·¨å¹³å°ç¡¬ä»¶ä¿¡æ¯è·å–
          - HTTP APIæœåŠ¡ (ç«¯å£18888)
          - å›¾å½¢ç”¨æˆ·ç•Œé¢
          - æˆæƒçŠ¶æ€ç®¡ç†
          
          ### ğŸ“‹ APIæ¥å£
          - `GET /api/machine-code` - è·å–æœºå™¨ç ä¿¡æ¯
          - `GET /api/auth-status` - æ£€æŸ¥æˆæƒçŠ¶æ€  
          - `POST /api/set-auth` - è®¾ç½®æˆæƒçŠ¶æ€
          - `GET /api/health` - å¥åº·æ£€æŸ¥
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}