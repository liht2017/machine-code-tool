name: æ„å»ºæœºå™¨ç è·å–å·¥å…·

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            asset_name: machine-code-tool-kylin
          - os: macos-latest
            target: universal-apple-darwin
            asset_name: machine-code-tool-macos
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            asset_name: machine-code-tool-windows

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: å®‰è£…Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target == 'universal-apple-darwin' && 'aarch64-apple-darwin,x86_64-apple-darwin' || matrix.target }}

    - name: ç¼“å­˜Cargoä¾èµ–
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: æ£€æŸ¥Dockerç¯å¢ƒ (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        echo "ğŸ³ æ£€æŸ¥Dockerç¯å¢ƒ..."
        docker --version
        docker info || sudo docker info
        echo "âœ… Dockerç¯å¢ƒæ£€æŸ¥å®Œæˆ"

    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        # macOSæ— éœ€é¢å¤–ä¾èµ–

    - name: å®‰è£…Tauri CLI
      run: |
        if ! command -v cargo-tauri &> /dev/null; then
          echo "Installing Tauri CLI..."
          cargo install tauri-cli --locked
        else
          echo "Tauri CLI already installed"
          cargo tauri --version
        fi
      shell: bash

    - name: æ„å»º
      run: |
        cd src-tauri
        echo "å¼€å§‹Tauriæ„å»º..."
        echo "ç›®æ ‡å¹³å°: ${{ matrix.target }}"
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "Rustç‰ˆæœ¬: $(rustc --version)"
        echo "Cargoç‰ˆæœ¬: $(cargo --version)"
        echo "Tauriç‰ˆæœ¬: $(cargo tauri --version)"
        
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          echo "ğŸ¯ Linuxæ„å»ºï¼šä½¿ç”¨Ubuntuå®¹å™¨è¿›è¡Œé™æ€æ„å»º"
          echo "ğŸ³ åˆ›å»ºå°½å¯èƒ½é™æ€çš„ç‰ˆæœ¬"
          
          # åˆ›å»ºUbuntuæ„å»ºè„šæœ¬
          echo '#!/bin/bash' > ubuntu-static-build.sh
          echo 'set -e' >> ubuntu-static-build.sh
          echo '' >> ubuntu-static-build.sh
          echo 'echo "ğŸ§ Ubuntu æ„å»ºç¯å¢ƒåˆå§‹åŒ–"' >> ubuntu-static-build.sh
          echo 'echo "ğŸ“¦ å®‰è£…æ„å»ºä¾èµ–..."' >> ubuntu-static-build.sh
          echo '' >> ubuntu-static-build.sh
          echo '# æ›´æ–°åŒ…ç®¡ç†å™¨' >> ubuntu-static-build.sh
          echo 'apt-get update' >> ubuntu-static-build.sh
          echo '' >> ubuntu-static-build.sh
          echo '# å®‰è£…åŸºç¡€æ„å»ºå·¥å…·' >> ubuntu-static-build.sh
          echo 'DEBIAN_FRONTEND=noninteractive apt-get install -y \' >> ubuntu-static-build.sh
          echo '    curl \' >> ubuntu-static-build.sh
          echo '    build-essential \' >> ubuntu-static-build.sh
          echo '    pkg-config \' >> ubuntu-static-build.sh
          echo '    libssl-dev \' >> ubuntu-static-build.sh
          echo '    libgtk-3-dev \' >> ubuntu-static-build.sh
          echo '    libwebkit2gtk-4.1-dev \' >> ubuntu-static-build.sh
          echo '    libayatana-appindicator3-dev \' >> ubuntu-static-build.sh
          echo '    librsvg2-dev' >> ubuntu-static-build.sh
          echo '' >> ubuntu-static-build.sh
          echo 'echo "ğŸ¦€ å®‰è£…Rust..."' >> ubuntu-static-build.sh
          echo 'curl -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable' >> ubuntu-static-build.sh
          echo 'source ~/.cargo/env' >> ubuntu-static-build.sh
          echo '' >> ubuntu-static-build.sh
          echo 'echo "ğŸ”§ å®‰è£…Tauri CLI..."' >> ubuntu-static-build.sh
          echo 'cargo install tauri-cli --locked' >> ubuntu-static-build.sh
          echo '' >> ubuntu-static-build.sh
          echo '# è¿›å…¥æºç ç›®å½•' >> ubuntu-static-build.sh
          echo 'cd /workspace' >> ubuntu-static-build.sh
          echo 'echo "å½“å‰ç›®å½•: $(pwd)"' >> ubuntu-static-build.sh
          echo 'echo "ç›®å½•å†…å®¹:"' >> ubuntu-static-build.sh
          echo 'ls -la' >> ubuntu-static-build.sh
          echo '' >> ubuntu-static-build.sh
          echo 'echo "ğŸš€ å¼€å§‹æ„å»º..."' >> ubuntu-static-build.sh
          echo 'cargo tauri build --no-bundle --verbose' >> ubuntu-static-build.sh
          echo '' >> ubuntu-static-build.sh
          echo 'echo "âœ… æ„å»ºå®Œæˆï¼ŒéªŒè¯ç»“æœ..."' >> ubuntu-static-build.sh
          echo 'if [ -f "target/release/machine-code-tool" ]; then' >> ubuntu-static-build.sh
          echo '    echo "ğŸ“¦ æ„å»ºäº§ç‰©å¤§å°ï¼š"' >> ubuntu-static-build.sh
          echo '    ls -lh target/release/machine-code-tool' >> ubuntu-static-build.sh
          echo '    echo "ğŸ” æ£€æŸ¥ä¾èµ–ï¼š"' >> ubuntu-static-build.sh
          echo '    ldd target/release/machine-code-tool || echo "ä¾èµ–æ£€æŸ¥å®Œæˆ"' >> ubuntu-static-build.sh
          echo 'else' >> ubuntu-static-build.sh
          echo '    echo "âŒ æ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"' >> ubuntu-static-build.sh
          echo '    exit 1' >> ubuntu-static-build.sh
          echo 'fi' >> ubuntu-static-build.sh

          chmod +x ubuntu-static-build.sh
          
          echo "ğŸ³ å¯åŠ¨Ubuntuå®¹å™¨è¿›è¡Œæ„å»º..."
          # ä½¿ç”¨Ubuntuå®¹å™¨é¿å…Alpineçš„muslé—®é¢˜
          sudo docker run --rm \
            -v "$(pwd):/workspace" \
            -w /workspace \
            ubuntu:22.04 \
            ./ubuntu-static-build.sh
            
          echo "âœ… Alpineé™æ€æ„å»ºå®Œæˆ"
          
          # å¤åˆ¶æ„å»ºç»“æœ
          if [ -f "target/release/machine-code-tool" ]; then
            cp target/release/machine-code-tool machine-code-tool-kylin-static
            chmod +x machine-code-tool-kylin-static
            
            echo "ğŸ“¦ æœ€ç»ˆé™æ€ç‰ˆæœ¬å·²å‡†å¤‡: machine-code-tool-kylin-static"
            echo "ğŸ“Š æ–‡ä»¶å¤§å°ï¼š"
            ls -lh machine-code-tool-kylin-static
            
            # æœ€ç»ˆéªŒè¯
            echo "ğŸ” æœ€ç»ˆéªŒè¯é™æ€é“¾æ¥ï¼š"
            ldd machine-code-tool-kylin-static || echo "âœ… å®Œå…¨é™æ€é“¾æ¥ï¼Œæ— ä»»ä½•ä¾èµ–"
            
            # åˆ›å»ºç®€æ´çš„ä½¿ç”¨è¯´æ˜
            echo "ğŸ§ æœºå™¨ç è·å–å·¥å…· - é“¶æ²³éº’éºŸç‰ˆï¼ˆé™æ€é“¾æ¥ï¼‰" > ä½¿ç”¨è¯´æ˜.txt
            echo "=======================================" >> ä½¿ç”¨è¯´æ˜.txt
            echo "" >> ä½¿ç”¨è¯´æ˜.txt
            echo "ğŸ‰ æ­¤ç‰ˆæœ¬ä¸ºå®Œå…¨é™æ€é“¾æ¥ï¼Œæ— éœ€å®‰è£…ä»»ä½•ä¾èµ–ï¼" >> ä½¿ç”¨è¯´æ˜.txt
            echo "" >> ä½¿ç”¨è¯´æ˜.txt
            echo "ğŸ’» ä½¿ç”¨æ–¹æ³•ï¼š" >> ä½¿ç”¨è¯´æ˜.txt
            echo "åŒå‡» machine-code-tool-kylin-static å³å¯è¿è¡Œ" >> ä½¿ç”¨è¯´æ˜.txt
            echo "" >> ä½¿ç”¨è¯´æ˜.txt
            echo "âœ¨ åŠŸèƒ½ï¼šè·å–æœºå™¨ç¡¬ä»¶ä¿¡æ¯ï¼Œæä¾›æŠ•æ ‡APIæœåŠ¡" >> ä½¿ç”¨è¯´æ˜.txt
            echo "ğŸ“ ç‰ˆæœ¬ï¼š2.1.0 (é™æ€é“¾æ¥ç‰ˆ)" >> ä½¿ç”¨è¯´æ˜.txt
            
            echo "âœ… é™æ€æ„å»ºå’Œæ‰“åŒ…å®Œæˆ"
          else
            echo "âŒ æœªæ‰¾åˆ°é™æ€æ„å»ºäº§ç‰©"
            exit 1
          fi
          
          # æ˜¾ç¤ºLinuxæ„å»ºäº§ç‰©
          echo "ğŸ“‹ Linuxæ„å»ºäº§ç‰©:"
          ls -la machine-code-tool-kylin-static ä½¿ç”¨è¯´æ˜.txt 2>/dev/null || echo "é™æ€æ„å»ºäº§ç‰©æ£€æŸ¥å®Œæˆ"
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
          echo "ğŸ macOSæ„å»ºï¼šåˆ›å»ºé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶"
          
          # æ„å»ºä¸¤ç§æ¶æ„
          echo "ğŸ“¦ æ„å»ºApple Siliconç‰ˆæœ¬..."
          cargo tauri build --target aarch64-apple-darwin --no-bundle --verbose
          
          echo "ğŸ“¦ æ„å»ºIntelç‰ˆæœ¬..."
          cargo tauri build --target x86_64-apple-darwin --no-bundle --verbose
          
          # åˆ›å»ºé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶
          echo "ğŸ”§ åˆ›å»ºé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶..."
          lipo -create \
            target/aarch64-apple-darwin/release/machine-code-tool \
            target/x86_64-apple-darwin/release/machine-code-tool \
            -output machine-code-tool-universal
          
          echo "ğŸ“ éªŒè¯æ–‡ä»¶ä½ç½®ï¼š"
          ls -la machine-code-tool-universal
          
          # éªŒè¯é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶
          echo "ğŸ” éªŒè¯é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼š"
          lipo -info machine-code-tool-universal
          file machine-code-tool-universal
          
          echo "âœ… macOSé€šç”¨ç‰ˆæœ¬åˆ›å»ºå®Œæˆ"
        else
          echo "ğŸš€ Windowsæ„å»º"
          cargo tauri build --target ${{ matrix.target }} --no-bundle --verbose
          
          # æ˜¾ç¤ºæ„å»ºäº§ç‰©
          echo "ğŸ“‹ æ„å»ºäº§ç‰©:"
          ls -la target/${{ matrix.target }}/release/machine-code-tool* 2>/dev/null || echo "æ„å»ºäº§ç‰©æ£€æŸ¥å®Œæˆ"
        fi
      shell: bash

    - name: å¤åˆ¶å¹¶é‡å‘½åæ„å»ºäº§ç‰©
      run: |
        mkdir -p upload
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          # Linux: å¤åˆ¶é™æ€æ„å»ºç‰ˆæœ¬
          echo "æŸ¥æ‰¾Linuxé™æ€æ„å»ºäº§ç‰©..."
          
          if [ -f "machine-code-tool-kylin-static" ]; then
            echo "ğŸ“¦ å¤åˆ¶é™æ€é“¾æ¥ç‰ˆæœ¬..."
            cp machine-code-tool-kylin-static upload/${{ matrix.asset_name }}-static
            cp ä½¿ç”¨è¯´æ˜.txt upload/ä½¿ç”¨è¯´æ˜.txt
            chmod +x upload/${{ matrix.asset_name }}-static
            echo "âœ… Linuxé™æ€ç‰ˆæœ¬å·²å‡†å¤‡å®Œæˆï¼ˆæ— ä»»ä½•ä¾èµ–ï¼‰"
          else
            echo "âŒ æœªæ‰¾åˆ°é™æ€æ„å»ºäº§ç‰©"
            exit 1
          fi
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
          # macOS: å¤åˆ¶é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶
          if [ -f "src-tauri/machine-code-tool-universal" ]; then
            cp src-tauri/machine-code-tool-universal upload/${{ matrix.asset_name }}
            chmod +x upload/${{ matrix.asset_name }}
            echo "âœ… macOSé€šç”¨ç‰ˆæœ¬æ–‡ä»¶å·²å‡†å¤‡å®Œæˆ"
          else
            echo "âŒ æœªæ‰¾åˆ°macOSé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶"
            echo "æ£€æŸ¥å¯ç”¨æ–‡ä»¶ï¼š"
            find . -name "machine-code-tool*" -type f 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½•machine-code-toolæ–‡ä»¶"
            exit 1
          fi
        elif [ "${{ matrix.os }}" = "windows-latest" ]; then
          # Windows: å¤åˆ¶exeæ–‡ä»¶
          cp src-tauri/target/${{ matrix.target }}/release/machine-code-tool.exe upload/${{ matrix.asset_name }}.exe
          echo "âœ… Windowsæ–‡ä»¶å·²å‡†å¤‡å®Œæˆ"
        else
          echo "âŒ æœªçŸ¥å¹³å°: ${{ matrix.os }}"
          exit 1
        fi
        ls -la upload/
      shell: bash

    - name: ç”Ÿæˆå¹³å°è¯´æ˜æ–‡ä»¶
      run: |
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          echo "ğŸš€ æœºå™¨ç è·å–å·¥å…· - Windowsç‰ˆ" > upload/ä½¿ç”¨è¯´æ˜.txt
          echo "=========================" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "ğŸ’» ä½¿ç”¨æ–¹æ³•ï¼š" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "åŒå‡» ${{ matrix.asset_name }}.exe å³å¯è¿è¡Œ" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "âœ¨ åŠŸèƒ½ï¼šè·å–æœºå™¨ç¡¬ä»¶ä¿¡æ¯ï¼Œæä¾›æŠ•æ ‡APIæœåŠ¡" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "ğŸ“ ç‰ˆæœ¬ï¼š2.1.0" >> upload/ä½¿ç”¨è¯´æ˜.txt
          
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
          echo "ğŸ æœºå™¨ç è·å–å·¥å…· - macOSç‰ˆï¼ˆé€šç”¨ç‰ˆæœ¬ï¼‰" > upload/ä½¿ç”¨è¯´æ˜.txt
          echo "=================================" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "ğŸ‰ æ­¤ç‰ˆæœ¬åŒæ—¶æ”¯æŒIntelå’ŒApple SiliconèŠ¯ç‰‡ï¼" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "ğŸ’» ä½¿ç”¨æ–¹æ³•ï¼š" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "åŒå‡» ${{ matrix.asset_name }} å³å¯è¿è¡Œ" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "ğŸ”’ å®‰å…¨æç¤ºï¼š" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "å¦‚æœç³»ç»Ÿæç¤º"æ¥è‡ªèº«ä»½ä¸æ˜çš„å¼€å‘è€…"ï¼Œè¯·ï¼š" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "1. å³é”®ç‚¹å‡»æ–‡ä»¶ â†’ æ‰“å¼€" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "2. æˆ–åœ¨ç»ˆç«¯è¿è¡Œï¼šxattr -rd com.apple.quarantine ${{ matrix.asset_name }}" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "âœ¨ åŠŸèƒ½ï¼šè·å–æœºå™¨ç¡¬ä»¶ä¿¡æ¯ï¼Œæä¾›æŠ•æ ‡APIæœåŠ¡" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "ğŸ“ ç‰ˆæœ¬ï¼š2.1.0ï¼ˆé€šç”¨ç‰ˆæœ¬ï¼‰" >> upload/ä½¿ç”¨è¯´æ˜.txt
        fi
      shell: bash

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.asset_name }}
        path: upload/
        retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        echo "åˆ›å»ºå‘å¸ƒåŒ…..."
        
        # ä¸ºæ¯ä¸ªå¹³å°åˆ›å»ºZIPåŒ…
        for dir in machine-code-tool-*; do
          if [ -d "$dir" ]; then
            echo "æ‰“åŒ… $dir..."
            cd "$dir"
            if [ "$dir" = "machine-code-tool-kylin" ]; then
              # Linuxé™æ€ç‰ˆæœ¬
              zip -r "../${dir}-static.zip" .
            else
              # å…¶ä»–å¹³å°
              zip -r "../${dir}.zip" .
            fi
            cd ..
          fi
        done
        
        ls -la *.zip
        
    - name: åˆ›å»ºRelease
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v2.1.0-${{ github.run_number }}
        name: æœºå™¨ç è·å–å·¥å…· v2.1.0-${{ github.run_number }}
        body: |
          ## ğŸ‰ æœºå™¨ç è·å–å·¥å…· v2.1.0
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - **Windowsç”¨æˆ·**ï¼šä¸‹è½½ `machine-code-tool-windows.zip`
          - **macOSç”¨æˆ·**ï¼šä¸‹è½½ `machine-code-tool-macos.zip`ï¼ˆé€šç”¨ç‰ˆæœ¬ï¼Œæ”¯æŒIntelå’ŒApple Siliconï¼‰
          - **é“¶æ²³éº’éºŸç”¨æˆ·**ï¼šä¸‹è½½ `machine-code-tool-kylin-static.zip`ï¼ˆé™æ€é“¾æ¥ï¼Œæ— ä¾èµ–ï¼‰
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - è·å–æœºå™¨ç¡¬ä»¶ä¿¡æ¯ï¼ˆMACåœ°å€ã€ä¸»æ¿åºåˆ—å·ã€CPUåºåˆ—å·ã€ç¡¬ç›˜åºåˆ—å·ï¼‰
          - æä¾›æœ¬åœ°APIæœåŠ¡ä¾›æŠ•æ ‡é¡µé¢è°ƒç”¨
          - æ˜¾ç¤ºè½¯ä»¶ç‰ˆæœ¬å’Œç”¨æˆ·åè®®
          - è·¨å¹³å°æ”¯æŒï¼ˆWindowsã€macOSã€é“¶æ²³éº’éºŸï¼‰
          
          ### ğŸ”§ æŠ€æœ¯ç‰¹æ€§
          - **é“¶æ²³éº’éºŸç‰ˆ**ï¼šå®Œå…¨é™æ€é“¾æ¥ï¼Œæ— éœ€å®‰è£…ä»»ä½•ä¾èµ–
          - **å…¶ä»–å¹³å°**ï¼šåŸç”Ÿæ„å»ºï¼Œæ€§èƒ½ä¼˜åŒ–
          - ä½¿ç”¨RuståŸç”ŸTLSï¼Œæ— OpenSSLä¾èµ–
          
          ### ğŸ“ ç‰ˆæœ¬ä¿¡æ¯
          - ç‰ˆæœ¬ï¼š2.1.0
          - æ„å»ºï¼š${{ github.run_number }}
          - æäº¤ï¼š${{ github.sha }}
        files: |
          *.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}