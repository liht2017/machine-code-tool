name: è·¨å¹³å°æ„å»º

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v2.1.0)'
        required: false
        default: 'latest'

jobs:
  build:
    strategy:
      fail-fast: false  # ä¸å› ä¸ºä¸€ä¸ªå¹³å°å¤±è´¥è€Œå–æ¶ˆå…¶ä»–å¹³å°
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: machine-code-tool.exe
            asset_name: machine-code-tool-windows
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: machine-code-tool
            asset_name: machine-code-tool-macos
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            artifact_name: machine-code-tool
            asset_name: machine-code-tool-kylin

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: å®‰è£…Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: ${{ matrix.target }}
    
    - name: æ·»åŠ å¤‡é€‰ç›®æ ‡
      if: matrix.target == 'x86_64-unknown-linux-musl'
      run: rustup target add x86_64-unknown-linux-gnu

    - name: ç¼“å­˜Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          src-tauri/target
        key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.target }}-
          ${{ runner.os }}-cargo-

    - name: å®‰è£…Linuxä¾èµ–å’Œé™æ€é“¾æ¥å·¥å…·
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        
        echo "ğŸ”§ å®‰è£…é™æ€é“¾æ¥æ„å»ºæ‰€éœ€çš„å®Œæ•´å·¥å…·é“¾..."
        
        # å®‰è£…åŸºæœ¬æ„å»ºå·¥å…·
        sudo apt-get install -y build-essential curl wget pkg-config
        
        # å®‰è£…muslå·¥å…·é“¾ï¼ˆç”¨äºå®Œå…¨é™æ€é“¾æ¥ï¼‰
        sudo apt-get install -y musl-tools musl-dev gcc-multilib
        
        # å®‰è£…å¼€å‘åº“ï¼ˆåŒ…æ‹¬é™æ€åº“ï¼‰
        sudo apt-get install -y libwebkit2gtk-4.1-dev || sudo apt-get install -y libwebkit2gtk-4.0-dev
        sudo apt-get install -y libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev
        
        # å°è¯•å®‰è£…é™æ€ç‰ˆæœ¬çš„åº“
        sudo apt-get install -y \
          libgtk-3-dev \
          libglib2.0-dev \
          libcairo2-dev \
          libpango1.0-dev \
          libgdk-pixbuf2.0-dev \
          libatk1.0-dev \
          libssl-dev \
          2>/dev/null || echo "éƒ¨åˆ†é™æ€åº“å®‰è£…å¤±è´¥ï¼Œç»§ç»­..."
        
        # æ£€æŸ¥å¯ç”¨çš„é™æ€åº“
        echo "ğŸ“‹ æ£€æŸ¥å¯ç”¨çš„é™æ€åº“ï¼š"
        find /usr/lib -name "*.a" | grep -E "(gtk|glib|webkit|ssl)" | head -20 || echo "æœªæ‰¾åˆ°ç›¸å…³é™æ€åº“"
        
        # æ£€æŸ¥muslå·¥å…·
        echo "ğŸ” æ£€æŸ¥muslå·¥å…·ï¼š"
        which musl-gcc || echo "musl-gccæœªæ‰¾åˆ°"
        musl-gcc --version 2>/dev/null || echo "musl-gccç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"

    - name: ç¼“å­˜Tauri CLI
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-tauri
        key: ${{ runner.os }}-tauri-cli-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-tauri-cli-

    - name: å®‰è£…Tauri CLI
      run: |
        if ! command -v cargo-tauri &> /dev/null; then
          echo "Installing Tauri CLI..."
          cargo install tauri-cli --locked
        else
          echo "Tauri CLI already installed"
          cargo tauri --version
        fi
      shell: bash

    - name: æ„å»º
      run: |
        cd src-tauri
        echo "å¼€å§‹Tauriæ„å»º..."
        echo "ç›®æ ‡å¹³å°: ${{ matrix.target }}"
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "Rustç‰ˆæœ¬: $(rustc --version)"
        echo "Cargoç‰ˆæœ¬: $(cargo --version)"
        echo "Tauriç‰ˆæœ¬: $(cargo tauri --version)"
        
        # ç®€åŒ–æ„å»ºï¼šæ‰€æœ‰å¹³å°éƒ½åªç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œé¿å…æ‰“åŒ…é—®é¢˜
        echo "æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè·³è¿‡å¤æ‚æ‰“åŒ…"
        echo "ä½¿ç”¨RuståŸç”ŸTLSï¼Œæ— éœ€OpenSSLä¾èµ–"
        
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          echo "ğŸ¯ Linuxæ„å»ºï¼šå¤šç§æ–¹æ¡ˆå°è¯•é™æ€é“¾æ¥"
          
          # æ–¹æ¡ˆ1: å°è¯•ç®€åŒ–çš„é™æ€é“¾æ¥
          echo "ğŸ”§ æ–¹æ¡ˆ1: å°è¯•ç®€åŒ–é™æ€é“¾æ¥ï¼ˆä»…é™æ€é“¾æ¥Rustéƒ¨åˆ†ï¼‰..."
          export RUSTFLAGS="-C target-feature=+crt-static"
          
          if cargo tauri build --target x86_64-unknown-linux-gnu --no-bundle --verbose; then
            echo "âœ… ç®€åŒ–é™æ€é“¾æ¥æˆåŠŸ"
            
            # æ£€æŸ¥æ˜¯å¦çœŸçš„å‡å°‘äº†ä¾èµ–
            echo "ğŸ” æ£€æŸ¥ä¾èµ–æƒ…å†µ..."
            ldd target/x86_64-unknown-linux-gnu/release/machine-code-tool || echo "å®Œå…¨é™æ€é“¾æ¥æˆåŠŸï¼"
            
            # è®¡ç®—ä¾èµ–æ•°é‡
            dep_count=$(ldd target/x86_64-unknown-linux-gnu/release/machine-code-tool 2>/dev/null | wc -l)
            if [ $dep_count -lt 20 ]; then
              echo "âœ… ä¾èµ–æ•°é‡è¾ƒå°‘($dep_count)ï¼Œæ¥è¿‘é™æ€é“¾æ¥æ•ˆæœ"
              STATIC_BUILD=semi_static
            else
              echo "âš ï¸ ä¾èµ–æ•°é‡è¾ƒå¤š($dep_count)ï¼Œéœ€è¦ä¾¿æºåŒ…"
              STATIC_BUILD=portable
            fi
          else
            echo "âŒ ç®€åŒ–é™æ€é“¾æ¥å¤±è´¥ï¼Œå°è¯•å®Œå…¨é™æ€é“¾æ¥..."
            
            # æ–¹æ¡ˆ2: å°è¯•å®Œå…¨é™æ€é“¾æ¥ï¼ˆAlpineæ–¹å¼ï¼‰
            echo "ğŸ”§ æ–¹æ¡ˆ2: ä½¿ç”¨Alpine Dockerè¿›è¡Œå®Œå…¨é™æ€é“¾æ¥..."
            
            # åˆ›å»ºAlpineæ„å»ºè„šæœ¬
            cat > alpine-static-build.sh << 'ALPINE_EOF'
#!/bin/sh
set -e

echo "ğŸ§ Alpine Linuxé™æ€æ„å»ºç¯å¢ƒ"
echo "å®‰è£…ä¾èµ–..."

# æ›´æ–°åŒ…ç®¡ç†å™¨
apk update

# å®‰è£…åŸºç¡€æ„å»ºå·¥å…·
apk add --no-cache \
    curl \
    build-base \
    pkgconfig \
    openssl-dev \
    openssl-libs-static

# å°è¯•å®‰è£…GTKé™æ€åº“ï¼ˆå¦‚æœå¯ç”¨ï¼‰
apk add --no-cache \
    gtk+3.0-dev \
    webkit2gtk-dev \
    || echo "GTKé™æ€åº“ä¸å¯ç”¨ï¼Œç»§ç»­..."

# å®‰è£…Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
source ~/.cargo/env

# æ·»åŠ muslç›®æ ‡
rustup target add x86_64-unknown-linux-musl

# å®‰è£…Tauri CLI
cargo install tauri-cli --locked

# è®¾ç½®é™æ€é“¾æ¥ç¯å¢ƒ
export PKG_CONFIG_ALL_STATIC=1
export RUSTFLAGS="-C target-feature=+crt-static -C link-arg=-static"

echo "ğŸ”§ å¼€å§‹é™æ€æ„å»º..."
cd /workspace/src-tauri

# å°è¯•muslé™æ€æ„å»º
if cargo tauri build --target x86_64-unknown-linux-musl --no-bundle --verbose; then
    echo "âœ… Alpine muslé™æ€æ„å»ºæˆåŠŸ"
    exit 0
else
    echo "âŒ Alpineé™æ€æ„å»ºå¤±è´¥"
    exit 1
fi
ALPINE_EOF

            chmod +x alpine-static-build.sh
            
            # æ£€æŸ¥Dockeræ˜¯å¦å¯ç”¨
            if command -v docker &> /dev/null; then
              echo "ğŸ³ ä½¿ç”¨Docker Alpineç¯å¢ƒæ„å»º..."
              if docker run --rm -v "$(pwd):/workspace" -w /workspace alpine:latest ./alpine-static-build.sh; then
                echo "âœ… Docker Alpineé™æ€æ„å»ºæˆåŠŸ"
                STATIC_BUILD=true
              else
                echo "âŒ Docker Alpineæ„å»ºå¤±è´¥ï¼Œå›é€€åˆ°ä¾¿æºåŒ…..."
                STATIC_BUILD=portable
              fi
            else
              echo "âŒ Dockerä¸å¯ç”¨ï¼Œå›é€€åˆ°ä¾¿æºåŒ…..."
              STATIC_BUILD=portable
            fi
          fi
          
          # å¦‚æœé™æ€é“¾æ¥å¤±è´¥ï¼Œåˆ›å»ºä¾¿æºåŒ…
          if [ "$STATIC_BUILD" = "portable" ]; then
            echo "ğŸ”„ å›é€€åˆ°ä¾¿æºåŒ…æ–¹æ¡ˆ..."
            # æ¸…ç†ç¯å¢ƒ
            unset RUSTFLAGS PKG_CONFIG_ALL_STATIC
            
            if cargo tauri build --target x86_64-unknown-linux-gnu --no-bundle --verbose; then
              echo "âœ… åŠ¨æ€é“¾æ¥æ„å»ºæˆåŠŸï¼Œå°†åˆ›å»ºä¾¿æºåŒ…..."
            else
              echo "âŒ æ‰€æœ‰æ„å»ºæ–¹æ¡ˆéƒ½å¤±è´¥äº†"
              exit 1
            fi
          fi
          
          echo "åå¤„ç†ï¼šæ ¹æ®æ„å»ºç±»å‹å¤„ç†æ–‡ä»¶"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "æŸ¥æ‰¾æ„å»ºäº§ç‰©ä½ç½®..."
          find . -name "machine-code-tool" -type f 2>/dev/null || true
          
          # ç¡®å®šæ­£ç¡®çš„æ„å»ºç›®å½•ï¼ˆæˆ‘ä»¬åœ¨src-tauriç›®å½•ä¸‹ï¼‰
          if [ -f "target/${{ matrix.target }}/release/machine-code-tool" ]; then
            BUILD_DIR="target/${{ matrix.target }}/release"
            ACTUAL_TARGET="${{ matrix.target }}"
          elif [ -f "target/x86_64-unknown-linux-gnu/release/machine-code-tool" ]; then
            BUILD_DIR="target/x86_64-unknown-linux-gnu/release"
            ACTUAL_TARGET="x86_64-unknown-linux-gnu"
          else
            echo "âŒ æ‰¾ä¸åˆ°æ„å»ºäº§ç‰©ï¼Œåˆ—å‡ºtargetç›®å½•å†…å®¹ï¼š"
            ls -la target/ 2>/dev/null || echo "targetç›®å½•ä¸å­˜åœ¨"
            find target -name "machine-code-tool" -type f 2>/dev/null || echo "æœªæ‰¾åˆ°machine-code-toolæ–‡ä»¶"
            exit 1
          fi
          
          echo "ä½¿ç”¨æ„å»ºç›®å½•: $BUILD_DIR"
          echo "å®é™…ç›®æ ‡: $ACTUAL_TARGET"
          cd "$BUILD_DIR"
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºé™æ€é“¾æ¥
          echo "æ£€æŸ¥æ„å»ºç±»å‹..."
          if ldd machine-code-tool | grep -q "not a dynamic executable"; then
            echo "âœ… æ£€æµ‹åˆ°é™æ€é“¾æ¥å¯æ‰§è¡Œæ–‡ä»¶"
            STATIC_BUILD=true
          elif ldd machine-code-tool | grep -q "libwebkit2gtk"; then
            echo "âš ï¸ æ£€æµ‹åˆ°åŠ¨æ€é“¾æ¥ï¼Œéœ€è¦åˆ›å»ºä¾¿æºåŒ…"
            STATIC_BUILD=false
          else
            echo "âœ… æ£€æµ‹åˆ°éƒ¨åˆ†é™æ€é“¾æ¥"
            STATIC_BUILD=partial
          fi
          
          # æ ¹æ®æ„å»ºç»“æœå¤„ç†æ–‡ä»¶
          if [ "$STATIC_BUILD" = "true" ]; then
            echo "ğŸ‰ å®Œå…¨é™æ€é“¾æ¥æˆåŠŸï¼åˆ›å»ºé™æ€ç‰ˆæœ¬..."
            mkdir -p static-app
            cp machine-code-tool static-app/
            
            echo "éªŒè¯é™æ€é“¾æ¥çŠ¶æ€..."
            if ldd static-app/machine-code-tool | grep -q "not a dynamic executable"; then
              echo "âœ… ç¡®è®¤ï¼šå®Œå…¨é™æ€é“¾æ¥"
            else
              echo "ğŸ“Š ä¾èµ–æƒ…å†µï¼š"
              ldd static-app/machine-code-tool
            fi
            
            # åˆ›å»ºè¯´æ˜æ–‡ä»¶
            cat > static-app/README.txt << 'STATIC_README'
ğŸ‰ é™æ€é“¾æ¥ç‰ˆæœ¬

æ­¤ç‰ˆæœ¬ä¸ºå®Œå…¨é™æ€é“¾æ¥ï¼Œæ— éœ€å®‰è£…ä»»ä½•ä¾èµ–åº“ï¼

ä½¿ç”¨æ–¹æ³•ï¼š
1. åŒå‡» machine-code-tool è¿è¡Œ
2. å¦‚æœæ— æ³•åŒå‡»ï¼Œå³é”® â†’ å±æ€§ â†’ æƒé™ â†’ å‹¾é€‰æ‰§è¡Œæƒé™

ç‰¹ç‚¹ï¼š
- å®Œå…¨æ— ä¾èµ–
- é€‚ç”¨äºä»»ä½•Linuxå‘è¡Œç‰ˆ
- æ–‡ä»¶è¾ƒå¤§ä½†æœ€å¯é 
STATIC_README

            tar -czf machine-code-tool-static.tar.gz static-app/
            echo "âœ… é™æ€ç‰ˆæœ¬æ‰“åŒ…å®Œæˆ"
            
          elif [ "$STATIC_BUILD" = "semi_static" ]; then
            echo "ğŸ”§ åŠé™æ€é“¾æ¥æˆåŠŸï¼ä¾èµ–è¾ƒå°‘..."
            mkdir -p semi-static-app
            cp machine-code-tool semi-static-app/
            
            echo "ğŸ“Š ä¾èµ–åˆ†æï¼š"
            ldd semi-static-app/machine-code-tool
            
            # åˆ›å»ºè¯´æ˜æ–‡ä»¶
            cat > semi-static-app/README.txt << 'SEMI_README'
ğŸ”§ åŠé™æ€é“¾æ¥ç‰ˆæœ¬

æ­¤ç‰ˆæœ¬å¤§éƒ¨åˆ†åº“å·²é™æ€é“¾æ¥ï¼Œåªä¾èµ–å°‘é‡ç³»ç»Ÿåº“ã€‚

ä½¿ç”¨æ–¹æ³•ï¼š
1. åŒå‡» machine-code-tool è¿è¡Œ
2. å¦‚æœæç¤ºç¼ºå°‘ä¾èµ–ï¼Œå®‰è£…åŸºç¡€å›¾å½¢åº“ï¼š
   sudo yum install -y gtk3
   æˆ– sudo apt install -y libgtk-3-0

ç‰¹ç‚¹ï¼š
- ä¾èµ–æå°‘
- æ–‡ä»¶è¾ƒå°
- å…¼å®¹æ€§å¥½
SEMI_README

            tar -czf machine-code-tool-semi-static.tar.gz semi-static-app/
            echo "âœ… åŠé™æ€ç‰ˆæœ¬æ‰“åŒ…å®Œæˆ"
            
          else
            echo "ğŸš€ åˆ›å»ºå®Œæ•´ä¾¿æºåŒ…ï¼ŒåŒ…å«æ‰€æœ‰ä¾èµ–åº“..."
            
            # åˆ›å»ºä¾¿æºç›®å½•ç»“æ„
            mkdir -p portable-app/lib
            cp machine-code-tool portable-app/
            
            echo "ğŸ“¦ æ”¶é›†æ‰€æœ‰ä¾èµ–åº“..."
          
          # å…¨é¢çš„ä¾èµ–æ”¶é›†ç­–ç•¥ï¼ˆç¡®ä¿æ— éœ€ç”¨æˆ·å®‰è£…ä»»ä½•ä¾èµ–ï¼‰
          echo "ğŸ” åˆ†ææ‰€æœ‰ä¾èµ–åº“..."
          ldd machine-code-tool | grep "=> /" | awk '{print $3}' > /tmp/direct_deps.txt
          
          # åˆ›å»ºå·²å¤åˆ¶åº“çš„è®°å½•
          touch /tmp/copied_libs.txt
          
          echo "ğŸ“¦ ç¬¬ä¸€è½®ï¼šæ”¶é›†ç›´æ¥ä¾èµ–..."
          while read lib; do
            if [ -f "$lib" ] && [ ! -z "$lib" ]; then
              # åªæ’é™¤æœ€æ ¸å¿ƒçš„ç³»ç»Ÿåº“ï¼Œå…¶ä»–éƒ½å¤åˆ¶
              if [[ "$lib" != "/lib/x86_64-linux-gnu/libc.so"* && \
                    "$lib" != "/lib/x86_64-linux-gnu/libdl.so"* && \
                    "$lib" != "/lib/x86_64-linux-gnu/libpthread.so"* && \
                    "$lib" != "/lib/x86_64-linux-gnu/libm.so"* && \
                    "$lib" != "/lib/x86_64-linux-gnu/librt.so"* && \
                    "$lib" != "/lib64/ld-linux-x86-64.so"* ]]; then
                
                libname=$(basename "$lib")
                if ! grep -q "^$libname$" /tmp/copied_libs.txt; then
                  echo "  ğŸ“¦ $lib"
                  if cp "$lib" portable-app/lib/ 2>/dev/null; then
                    echo "$libname" >> /tmp/copied_libs.txt
                  fi
                fi
              fi
            fi
          done < /tmp/direct_deps.txt
          
          echo "ğŸ”„ ç¬¬äºŒè½®ï¼šé€’å½’æ”¶é›†é—´æ¥ä¾èµ–..."
          # å¤šè½®é€’å½’ï¼Œç¡®ä¿æ”¶é›†å®Œæ•´
          for round in {1..4}; do
            echo "  ğŸ”„ é€’å½’è½®æ¬¡ $round..."
            new_libs_found=0
            
            for lib_file in portable-app/lib/*.so*; do
              if [ -f "$lib_file" ]; then
                ldd "$lib_file" 2>/dev/null | grep "=> /" | awk '{print $3}' | while read sublib; do
                  if [ -f "$sublib" ] && [ ! -z "$sublib" ]; then
                    sublibname=$(basename "$sublib")
                    if ! grep -q "^$sublibname$" /tmp/copied_libs.txt; then
                      # åŒæ ·çš„æ ¸å¿ƒç³»ç»Ÿåº“è¿‡æ»¤
                      if [[ "$sublib" != "/lib/x86_64-linux-gnu/libc.so"* && \
                            "$sublib" != "/lib/x86_64-linux-gnu/libdl.so"* && \
                            "$sublib" != "/lib/x86_64-linux-gnu/libpthread.so"* && \
                            "$sublib" != "/lib/x86_64-linux-gnu/libm.so"* && \
                            "$sublib" != "/lib/x86_64-linux-gnu/librt.so"* && \
                            "$sublib" != "/lib64/ld-linux-x86-64.so"* ]]; then
                        echo "    ğŸ“¦ $sublib"
                        if cp "$sublib" portable-app/lib/ 2>/dev/null; then
                          echo "$sublibname" >> /tmp/copied_libs.txt
                          new_libs_found=1
                        fi
                      fi
                    fi
                  fi
                done
              fi
            done
            
            # å¦‚æœè¿™è½®æ²¡æœ‰æ‰¾åˆ°æ–°åº“ï¼Œæå‰ç»“æŸ
            if [ $new_libs_found -eq 0 ]; then
              echo "  âœ… é€’å½’å®Œæˆï¼Œæ²¡æœ‰æ›´å¤šä¾èµ–"
              break
            fi
          done
          
            echo "âœ… ä¾èµ–æ”¶é›†å®Œæˆï¼"
            echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š"
            echo "  - æ”¶é›†çš„åº“æ–‡ä»¶æ•°é‡: $(ls -1 portable-app/lib/ | wc -l)"
            echo "  - ä¾¿æºåŒ…æ€»å¤§å°: $(du -sh portable-app | cut -f1)"
          fi
          
          # åˆ›å»ºæ™ºèƒ½å¯åŠ¨è„šæœ¬ï¼ˆæ— ä¾èµ–ç‰ˆæœ¬ï¼‰
          cat > portable-app/machine-code-tool-launcher << 'LAUNCHER_EOF'
#!/bin/bash
# æœºå™¨ç è·å–å·¥å…· - æ— ä¾èµ–å¯åŠ¨å™¨
# æ­¤è„šæœ¬ç¡®ä¿ç¨‹åºèƒ½æ‰¾åˆ°æ‰€æœ‰å¿…éœ€çš„åº“æ–‡ä»¶

# è·å–è„šæœ¬æ‰€åœ¨ç›®å½•
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "ğŸš€ å¯åŠ¨æœºå™¨ç è·å–å·¥å…·..."
echo "ğŸ“ ç¨‹åºç›®å½•: $DIR"

# æ£€æŸ¥ä¸»ç¨‹åº
if [ ! -f "$DIR/machine-code-tool" ]; then
    echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°ä¸»ç¨‹åºæ–‡ä»¶ machine-code-tool"
    exit 1
fi

# æ£€æŸ¥åº“ç›®å½•
if [ ! -d "$DIR/lib" ]; then
    echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°åº“æ–‡ä»¶ç›®å½• lib/"
    exit 1
fi

echo "ğŸ“š åº“æ–‡ä»¶æ•°é‡: $(ls -1 "$DIR/lib" | wc -l)"

# è®¾ç½®åº“è·¯å¾„ï¼ˆä¼˜å…ˆä½¿ç”¨æˆ‘ä»¬çš„åº“ï¼‰
export LD_LIBRARY_PATH="$DIR/lib:$LD_LIBRARY_PATH"

# è®¾ç½®å…¶ä»–å¯èƒ½éœ€è¦çš„ç¯å¢ƒå˜é‡
export PKG_CONFIG_PATH="$DIR/lib/pkgconfig:$PKG_CONFIG_PATH"
export XDG_DATA_DIRS="$DIR/share:${XDG_DATA_DIRS:-/usr/local/share:/usr/share}"

# GTKç›¸å…³ç¯å¢ƒå˜é‡ï¼ˆå¦‚æœå­˜åœ¨ç›¸åº”ç›®å½•ï¼‰
if [ -d "$DIR/lib/gdk-pixbuf-2.0" ]; then
    export GDK_PIXBUF_MODULE_FILE="$DIR/lib/gdk-pixbuf-2.0/2.10.0/loaders.cache"
    export GDK_PIXBUF_MODULEDIR="$DIR/lib/gdk-pixbuf-2.0/2.10.0/loaders"
fi

# æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
echo "ğŸ”§ LD_LIBRARY_PATH: ${LD_LIBRARY_PATH:0:100}..."

# å¯åŠ¨ç¨‹åº
echo "â–¶ï¸  å¯åŠ¨ç¨‹åº..."
exec "$DIR/machine-code-tool" "$@"
LAUNCHER_EOF

          chmod +x portable-app/machine-code-tool-launcher
          
          # åˆ›å»ºæ™ºèƒ½ä¾èµ–æ£€æŸ¥è„šæœ¬
          cat > portable-app/check-deps.sh << 'CHECK_EOF'
#!/bin/bash
# ä¾èµ–æ£€æŸ¥å·¥å…· - è¯Šæ–­ä¾¿æºåŒ…çŠ¶æ€

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "ğŸ” æœºå™¨ç è·å–å·¥å…· - ä¾èµ–æ£€æŸ¥"
echo "================================"
echo "ğŸ“ ç¨‹åºç›®å½•: $DIR"
echo ""

# æ£€æŸ¥æ–‡ä»¶ç»“æ„
echo "ğŸ“‹ æ–‡ä»¶ç»“æ„æ£€æŸ¥:"
if [ -f "$DIR/machine-code-tool" ]; then
    echo "  âœ… ä¸»ç¨‹åº: machine-code-tool"
else
    echo "  âŒ ä¸»ç¨‹åº: machine-code-tool (ç¼ºå¤±)"
fi

if [ -d "$DIR/lib" ]; then
    lib_count=$(ls -1 "$DIR/lib" | wc -l)
    echo "  âœ… åº“ç›®å½•: lib/ (åŒ…å« $lib_count ä¸ªæ–‡ä»¶)"
else
    echo "  âŒ åº“ç›®å½•: lib/ (ç¼ºå¤±)"
fi

echo ""

# æ£€æŸ¥ä¾èµ–çŠ¶æ€
echo "ğŸ”— ä¾èµ–åº“æ£€æŸ¥:"
export LD_LIBRARY_PATH="$DIR/lib:$LD_LIBRARY_PATH"

if [ -f "$DIR/machine-code-tool" ]; then
    missing_deps=$(ldd "$DIR/machine-code-tool" 2>/dev/null | grep "not found" | wc -l)
    if [ $missing_deps -eq 0 ]; then
        echo "  âœ… æ‰€æœ‰ä¾èµ–åº“éƒ½å·²æ»¡è¶³"
    else
        echo "  âŒ å‘ç° $missing_deps ä¸ªç¼ºå¤±çš„ä¾èµ–:"
        ldd "$DIR/machine-code-tool" 2>/dev/null | grep "not found"
        echo ""
        echo "ğŸ’¡ è§£å†³æ–¹æ¡ˆ:"
        echo "  1. æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å®‰è£…äº†åŸºç¡€å›¾å½¢åº“"
        echo "  2. å°è¯•å®‰è£…: sudo yum install -y gtk3 webkit2gtk3"
        echo "  3. æˆ–è€…: sudo apt install -y libgtk-3-0 libwebkit2gtk-4.1-0"
    fi
else
    echo "  âŒ æ— æ³•æ£€æŸ¥ä¾èµ– (ä¸»ç¨‹åºä¸å­˜åœ¨)"
fi

echo ""
echo "ğŸ“Š ä¾¿æºåŒ…ä¿¡æ¯:"
echo "  - åº“æ–‡ä»¶æ•°é‡: $(ls -1 "$DIR/lib" 2>/dev/null | wc -l)"
echo "  - æ€»å¤§å°: $(du -sh "$DIR" 2>/dev/null | cut -f1)"

echo ""
echo "ğŸš€ å¯åŠ¨æµ‹è¯•:"
echo "  è¿è¡Œå‘½ä»¤: ./machine-code-tool-launcher"
CHECK_EOF

          chmod +x portable-app/check-deps.sh
          
          # æ˜¾ç¤ºä¾¿æºåŒ…å†…å®¹
          echo "ä¾¿æºåŒ…å†…å®¹:"
          ls -la portable-app/
          echo "åŒ…å«çš„åº“:"
          ls -la portable-app/lib/
          
            # æ‰“åŒ…ä¸ºtar.gz
            tar -czf machine-code-tool-portable.tar.gz portable-app/
            
            echo "âœ… åˆ›å»ºäº†ä¾¿æºç‰ˆæœ¬"
          fi
          
          # æ˜¾ç¤ºæœ€ç»ˆç»“æœ
          echo "æœ€ç»ˆæ„å»ºäº§ç‰©:"
          ls -la *.tar.gz 2>/dev/null || ls -la machine-code-tool
        else
          cargo tauri build --target ${{ matrix.target }} --no-bundle --verbose
        fi
        
        # æ£€æŸ¥æ„å»ºç»“æœ
        echo "æ„å»ºå®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºæ–‡ä»¶..."
        find target -name "machine-code-tool*" -type f || echo "æœªæ‰¾åˆ°æ„å»ºäº§ç‰©"
      shell: bash

    - name: æ„å»ºå¤±è´¥æ—¶çš„è°ƒè¯•ä¿¡æ¯
      if: failure()
      run: |
        echo "æ„å»ºå¤±è´¥ï¼Œæ”¶é›†è°ƒè¯•ä¿¡æ¯..."
        echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
        uname -a || echo "æ— æ³•è·å–ç³»ç»Ÿä¿¡æ¯"
        echo "=== ç¯å¢ƒå˜é‡ ==="
        env | grep -E "(RUST|CARGO|PATH)" || echo "æ— æ³•è·å–ç¯å¢ƒå˜é‡"
        echo "=== ç£ç›˜ç©ºé—´ ==="
        df -h || echo "æ— æ³•è·å–ç£ç›˜ä¿¡æ¯"
        echo "=== æ„å»ºæ—¥å¿— ==="
        if [ -f "src-tauri/target/${{ matrix.target }}/release/build/*/out/build.log" ]; then
          cat src-tauri/target/${{ matrix.target }}/release/build/*/out/build.log
        fi
      shell: bash

    - name: æŸ¥æ‰¾æ„å»ºæ–‡ä»¶
      run: |
        echo "æŸ¥æ‰¾Linuxæ„å»ºäº§ç‰©..."
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          echo "åœ¨src-tauriç›®å½•ä¸­æŸ¥æ‰¾..."
          find src-tauri/target -name "machine-code-tool*" -type f 2>/dev/null || echo "æœªåœ¨src-tauri/targetæ‰¾åˆ°æ–‡ä»¶"
          echo "æ£€æŸ¥å¯èƒ½çš„ç›®å½•ç»“æ„..."
          ls -la src-tauri/target/ 2>/dev/null || echo "src-tauri/targetç›®å½•ä¸å­˜åœ¨"
          ls -la src-tauri/target/${{ matrix.target }}/ 2>/dev/null || echo "${{ matrix.target }}ç›®å½•ä¸å­˜åœ¨"
          ls -la src-tauri/target/${{ matrix.target }}/release/ 2>/dev/null || echo "releaseç›®å½•ä¸å­˜åœ¨"
          ls -la src-tauri/target/x86_64-unknown-linux-gnu/release/ 2>/dev/null || echo "gnu releaseç›®å½•ä¸å­˜åœ¨"
        else
          echo "æŸ¥æ‰¾å…¶ä»–å¹³å°æ„å»ºäº§ç‰©..."
          find src-tauri/target -name "machine-code-tool*" -type f || true
          ls -la src-tauri/target/${{ matrix.target }}/release/ || true
        fi
      shell: bash

    - name: å¤åˆ¶å¹¶é‡å‘½åæ„å»ºäº§ç‰©
      run: |
        mkdir -p upload
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          # Windows: å¤åˆ¶exeæ–‡ä»¶ï¼Œä¿æŒ.exeåç¼€
          cp src-tauri/target/${{ matrix.target }}/release/machine-code-tool.exe upload/${{ matrix.asset_name }}.exe
        elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          # Linux: æŸ¥æ‰¾å¹¶å¤åˆ¶æ„å»ºäº§ç‰©
          echo "æŸ¥æ‰¾Linuxæ„å»ºäº§ç‰©..."
          
          # ç¡®å®šæ„å»ºç›®å½•
          if [ -f "src-tauri/target/${{ matrix.target }}/release/machine-code-tool" ]; then
            BUILD_DIR="src-tauri/target/${{ matrix.target }}/release"
          elif [ -f "target/${{ matrix.target }}/release/machine-code-tool" ]; then
            BUILD_DIR="target/${{ matrix.target }}/release"
          else
            echo "âŒ æ‰¾ä¸åˆ°Linuxæ„å»ºäº§ç‰©"
            exit 1
          fi
          
          # æŒ‰ä¼˜å…ˆçº§å¤åˆ¶ç‰ˆæœ¬
          if [ -f "$BUILD_DIR/machine-code-tool-static.tar.gz" ]; then
            echo "ğŸ‰ å¤åˆ¶å®Œå…¨é™æ€é“¾æ¥ç‰ˆæœ¬..."
            cp "$BUILD_DIR/machine-code-tool-static.tar.gz" upload/${{ matrix.asset_name }}-static.tar.gz
            echo "âœ… Linuxé™æ€ç‰ˆæœ¬å·²å‡†å¤‡å®Œæˆï¼ˆå®Œå…¨æ— ä¾èµ–ï¼‰"
          elif [ -f "$BUILD_DIR/machine-code-tool-semi-static.tar.gz" ]; then
            echo "ğŸ”§ å¤åˆ¶åŠé™æ€é“¾æ¥ç‰ˆæœ¬..."
            cp "$BUILD_DIR/machine-code-tool-semi-static.tar.gz" upload/${{ matrix.asset_name }}-semi-static.tar.gz
            echo "âœ… LinuxåŠé™æ€ç‰ˆæœ¬å·²å‡†å¤‡å®Œæˆï¼ˆä¾èµ–æå°‘ï¼‰"
          elif [ -f "$BUILD_DIR/machine-code-tool-portable.tar.gz" ]; then
            echo "ğŸ“¦ å¤åˆ¶ä¾¿æºç‰ˆæœ¬..."
            cp "$BUILD_DIR/machine-code-tool-portable.tar.gz" upload/${{ matrix.asset_name }}-portable.tar.gz
            echo "âœ… Linuxä¾¿æºç‰ˆæœ¬å·²å‡†å¤‡å®Œæˆï¼ˆåŒ…å«æ‰€æœ‰ä¾èµ–åº“ï¼‰"
          else
            echo "âŒ æ‰€æœ‰æ‰“åŒ…æ–¹æ¡ˆéƒ½å¤±è´¥ï¼Œä½¿ç”¨æ ‡å‡†ç‰ˆæœ¬..."
            cp "$BUILD_DIR/machine-code-tool" upload/${{ matrix.asset_name }}
            chmod +x upload/${{ matrix.asset_name }}
            echo "âš ï¸ Linuxæ ‡å‡†ç‰ˆæœ¬ï¼ˆéœ€è¦ç³»ç»Ÿä¾èµ–ï¼‰"
          fi
        else
          # macOS: å¤åˆ¶æ–‡ä»¶å¹¶æ·»åŠ æ‰§è¡Œæƒé™
          cp src-tauri/target/${{ matrix.target }}/release/machine-code-tool upload/${{ matrix.asset_name }}
          chmod +x upload/${{ matrix.asset_name }}
          echo "âœ… macOSæ–‡ä»¶å·²å‡†å¤‡å®Œæˆ"
        fi
        ls -la upload/
      shell: bash

    - name: ç”Ÿæˆå¹³å°è¯´æ˜æ–‡ä»¶
      run: |
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          echo "ğŸš€ æœºå™¨ç è·å–å·¥å…· - Windowsç‰ˆ" > upload/ä½¿ç”¨è¯´æ˜.txt
          echo "=========================" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "âœ… ä½¿ç”¨æ–¹æ³•:" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "åŒå‡» machine-code-tool-windows.exe è¿è¡Œå³å¯" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "ğŸ“‹ åŠŸèƒ½è¯´æ˜:" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- è·å–æœ¬æœºç¡¬ä»¶ä¿¡æ¯ï¼ˆMACåœ°å€ã€ä¸»æ¿åºåˆ—å·ç­‰ï¼‰" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- ç”Ÿæˆå”¯ä¸€æœºå™¨ç ç”¨äºè½¯ä»¶æˆæƒ" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "â“ å¸¸è§é—®é¢˜:" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- å¦‚æœæ€æ¯’è½¯ä»¶æ‹¦æˆªï¼Œè¯·æ·»åŠ ä¿¡ä»»" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- ç¨‹åºè¿è¡Œæ—¶è¯·å‹¿å…³é—­é»‘è‰²çª—å£" >> upload/ä½¿ç”¨è¯´æ˜.txt
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
          echo "ğŸ æœºå™¨ç è·å–å·¥å…· - macOSç‰ˆ" > upload/ä½¿ç”¨è¯´æ˜.txt
          echo "========================" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "âœ… ä½¿ç”¨æ–¹æ³•:" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "åŒå‡» machine-code-tool-macos æ–‡ä»¶è¿è¡Œå³å¯" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "ğŸ“‹ åŠŸèƒ½è¯´æ˜:" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- è·å–æœ¬æœºç¡¬ä»¶ä¿¡æ¯ï¼ˆMACåœ°å€ã€ä¸»æ¿åºåˆ—å·ç­‰ï¼‰" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- ç”Ÿæˆå”¯ä¸€æœºå™¨ç ç”¨äºè½¯ä»¶æˆæƒ" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "ğŸ”’ å®‰å…¨æç¤º:" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "å¦‚æç¤º'æ— æ³•éªŒè¯å¼€å‘è€…':" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- å³é”®ç‚¹å‡»æ–‡ä»¶ â†’ é€‰æ‹©'æ‰“å¼€'" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- æˆ–åˆ° ç³»ç»Ÿåå¥½è®¾ç½® â†’ å®‰å…¨æ€§ä¸éšç§ â†’ ç‚¹å‡»'ä»è¦æ‰“å¼€'" >> upload/ä½¿ç”¨è¯´æ˜.txt
        else
          # æ ¹æ®æ„å»ºç»“æœç”Ÿæˆä¸åŒçš„è¯´æ˜
          if ls upload/*-static.tar.gz >/dev/null 2>&1; then
            echo "ğŸ§ æœºå™¨ç è·å–å·¥å…· - é“¶æ²³éº’éºŸç‰ˆï¼ˆå®Œå…¨é™æ€ç‰ˆæœ¬ï¼‰" > upload/ä½¿ç”¨è¯´æ˜.txt
            echo "===========================================" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "ğŸ‰ æ­¤ç‰ˆæœ¬ä¸ºå®Œå…¨é™æ€é“¾æ¥ï¼ŒçœŸæ­£çš„é›¶ä¾èµ–ï¼" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "âœ¨ ç‰ˆæœ¬ç‰¹ç‚¹:" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "â€¢ å®Œå…¨é™æ€é“¾æ¥ï¼šæ‰€æœ‰åº“éƒ½ç¼–è¯‘åˆ°ç¨‹åºä¸­" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "â€¢ çœŸæ­£é›¶ä¾èµ–ï¼šæ— éœ€å®‰è£…ä»»ä½•ç³»ç»Ÿåº“" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "â€¢ é€‚ç”¨äºä»»ä½•Linuxå‘è¡Œç‰ˆ" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "â€¢ æ–‡ä»¶è¾ƒå¤§ä½†æœ€å¯é " >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "âœ… ä½¿ç”¨æ–¹æ³•:" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "1. è§£å‹æ–‡ä»¶: å³é”®ç‚¹å‡» .tar.gz æ–‡ä»¶ â†’ è§£å‹" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "2. è¿›å…¥è§£å‹åçš„ static-app æ–‡ä»¶å¤¹" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "3. åŒå‡» machine-code-tool å¯åŠ¨ç¨‹åº" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "ğŸ’¡ å¦‚æœåŒå‡»æ— æ•ˆ:" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "å³é”®ç‚¹å‡»æ–‡ä»¶ â†’ å±æ€§ â†’ æƒé™ â†’ å‹¾é€‰"å…è®¸ä½œä¸ºç¨‹åºæ‰§è¡Œ" â†’ å†æ¬¡åŒå‡»" >> upload/ä½¿ç”¨è¯´æ˜.txt
          elif ls upload/*-semi-static.tar.gz >/dev/null 2>&1; then
            echo "ğŸ§ æœºå™¨ç è·å–å·¥å…· - é“¶æ²³éº’éºŸç‰ˆï¼ˆåŠé™æ€ç‰ˆæœ¬ï¼‰" > upload/ä½¿ç”¨è¯´æ˜.txt
            echo "=========================================" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "ğŸ”§ æ­¤ç‰ˆæœ¬ä¸ºåŠé™æ€é“¾æ¥ï¼Œä¾èµ–æå°‘ï¼" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "âœ¨ ç‰ˆæœ¬ç‰¹ç‚¹:" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "â€¢ å¤§éƒ¨åˆ†åº“å·²é™æ€é“¾æ¥" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "â€¢ åªä¾èµ–å°‘é‡åŸºç¡€ç³»ç»Ÿåº“" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "â€¢ æ–‡ä»¶è¾ƒå°ï¼Œå…¼å®¹æ€§å¥½" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "â€¢ é€‚ç”¨äºå¤§å¤šæ•°Linuxç³»ç»Ÿ" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "âœ… ä½¿ç”¨æ–¹æ³•:" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "1. è§£å‹æ–‡ä»¶: å³é”®ç‚¹å‡» .tar.gz æ–‡ä»¶ â†’ è§£å‹" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "2. è¿›å…¥è§£å‹åçš„ semi-static-app æ–‡ä»¶å¤¹" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "3. åŒå‡» machine-code-tool å¯åŠ¨ç¨‹åº" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "ğŸ’¡ å¦‚æœæç¤ºç¼ºå°‘ä¾èµ–:" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "sudo yum install -y gtk3" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "æˆ–è€…: sudo apt install -y libgtk-3-0" >> upload/ä½¿ç”¨è¯´æ˜.txt
          elif ls upload/*-portable.tar.gz >/dev/null 2>&1; then
            echo "ğŸ§ æœºå™¨ç è·å–å·¥å…· - é“¶æ²³éº’éºŸç‰ˆï¼ˆæ— ä¾èµ–ç‰ˆæœ¬ï¼‰" > upload/ä½¿ç”¨è¯´æ˜.txt
            echo "========================================" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "ğŸ‰ æ­¤ç‰ˆæœ¬åŒ…å«æ‰€æœ‰ä¾èµ–åº“ï¼Œæ— éœ€å®‰è£…ä»»ä½•ç³»ç»Ÿè½¯ä»¶åŒ…ï¼" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "âœ¨ ç‰ˆæœ¬ç‰¹ç‚¹:" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "â€¢ çœŸæ­£çš„æ— ä¾èµ–ï¼šåŒ…å«æ‰€æœ‰å¿…éœ€çš„åº“æ–‡ä»¶" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "â€¢ æ— éœ€rootæƒé™å®‰è£…ä»»ä½•è½¯ä»¶åŒ…" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "â€¢ é€‚ç”¨äºä»»ä½•Linuxå‘è¡Œç‰ˆï¼ˆé“¶æ²³éº’éºŸã€CentOSã€Ubuntuç­‰ï¼‰" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "â€¢ ä¸‹è½½è§£å‹å³å¯ä½¿ç”¨ï¼Œå¼€ç®±å³ç”¨" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "âœ… ä½¿ç”¨æ–¹æ³•:" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "1. è§£å‹æ–‡ä»¶: å³é”®ç‚¹å‡» .tar.gz æ–‡ä»¶ â†’ è§£å‹åˆ°æ­¤å¤„" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "2. è¿›å…¥è§£å‹åçš„ portable-app æ–‡ä»¶å¤¹" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "3. åŒå‡» machine-code-tool-launcher å¯åŠ¨ç¨‹åº" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "ğŸ’¡ å¦‚æœåŒå‡»æ— æ•ˆï¼ˆè®¾ç½®æ‰§è¡Œæƒé™ï¼‰:" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "å³é”®ç‚¹å‡» machine-code-tool-launcher â†’ å±æ€§ â†’ æƒé™ â†’ å‹¾é€‰"å…è®¸ä½œä¸ºç¨‹åºæ‰§è¡Œ" â†’ å†æ¬¡åŒå‡»" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "ğŸ”§ æ•…éšœæ’é™¤ï¼ˆæå°‘æ•°æƒ…å†µï¼‰:" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "1. åŒå‡» check-deps.sh æ£€æŸ¥ä¾èµ–çŠ¶æ€" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "2. å¦‚æœä»æœ‰é—®é¢˜ï¼Œå¯èƒ½éœ€è¦å®‰è£…æœ€åŸºç¡€çš„ç³»ç»Ÿåº“" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "ğŸ’ª ä¼˜åŠ¿è¯´æ˜:" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "ç›¸æ¯”ä¼ ç»Ÿç‰ˆæœ¬éœ€è¦ç”¨æˆ·å®‰è£… webkit2gtkã€gtk3 ç­‰ä¾èµ–ï¼Œ" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "æ­¤ç‰ˆæœ¬å·²å°†æ‰€æœ‰ä¾èµ–æ‰“åŒ…ï¼ŒçœŸæ­£åšåˆ°äº†å¼€ç®±å³ç”¨ï¼" >> upload/ä½¿ç”¨è¯´æ˜.txt
          else
            echo "ğŸ§ æœºå™¨ç è·å–å·¥å…· - é“¶æ²³éº’éºŸç‰ˆï¼ˆæ ‡å‡†ç‰ˆæœ¬ï¼‰" > upload/ä½¿ç”¨è¯´æ˜.txt
            echo "=======================================" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "âœ… ä½¿ç”¨æ–¹æ³•:" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "1. å³é”®ç‚¹å‡» machine-code-tool-kylin æ–‡ä»¶" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "2. é€‰æ‹©"å±æ€§" â†’ "æƒé™" â†’ å‹¾é€‰"å…è®¸ä½œä¸ºç¨‹åºæ‰§è¡Œæ–‡ä»¶"" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "3. åŒå‡»æ–‡ä»¶è¿è¡Œ" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "â“ å¦‚æœæ— æ³•å¯åŠ¨:" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "å¯èƒ½éœ€è¦å®‰è£…ç³»ç»Ÿä¾èµ–: sudo yum install -y webkit2gtk4.1" >> upload/ä½¿ç”¨è¯´æ˜.txt
            echo "æˆ–è€…: sudo apt install -y libwebkit2gtk-4.1-0" >> upload/ä½¿ç”¨è¯´æ˜.txt
          fi
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "ğŸ“‹ åŠŸèƒ½è¯´æ˜:" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- è·å–æœ¬æœºç¡¬ä»¶ä¿¡æ¯ï¼ˆMACåœ°å€ã€ä¸»æ¿åºåˆ—å·ç­‰ï¼‰" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- ç”Ÿæˆå”¯ä¸€æœºå™¨ç ç”¨äºè½¯ä»¶æˆæƒ" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "ğŸ’¡ æç¤º:" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- é€‚ç”¨äºé“¶æ²³éº’éºŸæ¡Œé¢æ“ä½œç³»ç»Ÿ" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- ç¨‹åºå¯åŠ¨åä¼šæ˜¾ç¤ºæ“ä½œç•Œé¢" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- å¦‚éœ€å…³é—­ç¨‹åºï¼Œç‚¹å‡»çª—å£å…³é—­æŒ‰é’®å³å¯" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
        fi
      shell: bash

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.asset_name }}
        path: upload/

  collect:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        pattern: machine-code-tool-*
        merge-multiple: true
      
    - name: æ•´ç†æ–‡ä»¶å¹¶æ·»åŠ æ­£ç¡®æ‰©å±•å
      run: |
        mkdir -p release
        
        echo "å½“å‰ç›®å½•æ–‡ä»¶:"
        ls -la
        
        # å¤„ç†æ‰€æœ‰ä¸‹è½½çš„æ–‡ä»¶
        for file in machine-code-tool-*; do
          if [ -f "$file" ]; then
            echo "å¤„ç†æ–‡ä»¶: $file"
            cp "$file" "release/$file"
            chmod +x "release/$file"
          fi
        done
        
        # macOSæ–‡ä»¶å·²ç»åœ¨ä¸Šé¢çš„å¾ªç¯ä¸­å¤„ç†äº†
        
        
        ls -la release/
      shell: bash
        
    - name: ä¸Šä¼ æœ€ç»ˆäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: all-platforms-${{ github.run_number }}
        path: release/
        
    - name: åˆ›å»ºRelease (ä»…æ ‡ç­¾æ¨é€æ—¶)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: release/*
        name: æœºå™¨ç è·å–å·¥å…· ${{ github.ref_name }}
        body: |
          ## ğŸš€ æœºå™¨ç è·å–å·¥å…· ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½é“¾æ¥
          - **Windows**: machine-code-tool-windows.exe
          - **macOS Intel**: machine-code-tool-macos-intel  
          - **macOS ARM**: machine-code-tool-macos-arm
          - **é“¶æ²³éº’éºŸ**: machine-code-tool-kylin
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - è·¨å¹³å°ç¡¬ä»¶ä¿¡æ¯è·å–
          - HTTP APIæœåŠ¡ (ç«¯å£18888)
          - å›¾å½¢ç”¨æˆ·ç•Œé¢
          - æˆæƒçŠ¶æ€ç®¡ç†
          
          ### ğŸ“‹ APIæ¥å£
          - `GET /api/machine-code` - è·å–æœºå™¨ç ä¿¡æ¯
          - `GET /api/auth-status` - æ£€æŸ¥æˆæƒçŠ¶æ€  
          - `POST /api/set-auth` - è®¾ç½®æˆæƒçŠ¶æ€
          - `GET /api/health` - å¥åº·æ£€æŸ¥
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}