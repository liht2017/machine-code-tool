name: è·¨å¹³å°æ„å»º

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v2.1.0)'
        required: false
        default: 'latest'

jobs:
  build:
    strategy:
      fail-fast: false  # ä¸å› ä¸ºä¸€ä¸ªå¹³å°å¤±è´¥è€Œå–æ¶ˆå…¶ä»–å¹³å°
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: machine-code-tool.exe
            asset_name: machine-code-tool-windows
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: machine-code-tool
            asset_name: machine-code-tool-macos
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: machine-code-tool
            asset_name: machine-code-tool-kylin

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: å®‰è£…Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: ${{ matrix.target }}

    - name: ç¼“å­˜Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          src-tauri/target
        key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.target }}-
          ${{ runner.os }}-cargo-

    - name: å®‰è£…Linuxä¾èµ–
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        # å®‰è£…åŸºæœ¬æ„å»ºå·¥å…·
        sudo apt-get install -y build-essential curl wget pkg-config
        # ä½¿ç”¨è¾ƒæ–°çš„Ubuntuç‰ˆæœ¬ä¸­çš„WebKitåº“ï¼Œå‡å°‘å…¼å®¹æ€§é—®é¢˜
        sudo apt-get install -y libwebkit2gtk-4.1-dev || sudo apt-get install -y libwebkit2gtk-4.0-dev
        sudo apt-get install -y libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev

    - name: ç¼“å­˜Tauri CLI
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-tauri
        key: ${{ runner.os }}-tauri-cli-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-tauri-cli-

    - name: å®‰è£…Tauri CLI
      run: |
        if ! command -v cargo-tauri &> /dev/null; then
          echo "Installing Tauri CLI..."
          cargo install tauri-cli --locked
        else
          echo "Tauri CLI already installed"
          cargo tauri --version
        fi
      shell: bash

    - name: æ„å»º
      run: |
        cd src-tauri
        echo "å¼€å§‹Tauriæ„å»º..."
        echo "ç›®æ ‡å¹³å°: ${{ matrix.target }}"
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "Rustç‰ˆæœ¬: $(rustc --version)"
        echo "Cargoç‰ˆæœ¬: $(cargo --version)"
        echo "Tauriç‰ˆæœ¬: $(cargo tauri --version)"
        
        # ç®€åŒ–æ„å»ºï¼šæ‰€æœ‰å¹³å°éƒ½åªç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œé¿å…æ‰“åŒ…é—®é¢˜
        echo "æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè·³è¿‡å¤æ‚æ‰“åŒ…"
        echo "ä½¿ç”¨RuståŸç”ŸTLSï¼Œæ— éœ€OpenSSLä¾èµ–"
        
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          echo "Linuxæ„å»ºï¼šç”ŸæˆAppImageæ ¼å¼ï¼ŒçœŸæ­£çš„å¼€ç®±å³ç”¨"
          # ç”ŸæˆAppImageï¼ŒåŒ…å«æ‰€æœ‰ä¾èµ–åº“
          cargo tauri build --target ${{ matrix.target }} --bundles appimage --verbose
        else
          cargo tauri build --target ${{ matrix.target }} --no-bundle --verbose
        fi
        
        # æ£€æŸ¥æ„å»ºç»“æœ
        echo "æ„å»ºå®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºæ–‡ä»¶..."
        find target -name "machine-code-tool*" -type f || echo "æœªæ‰¾åˆ°æ„å»ºäº§ç‰©"
      shell: bash

    - name: æ„å»ºå¤±è´¥æ—¶çš„è°ƒè¯•ä¿¡æ¯
      if: failure()
      run: |
        echo "æ„å»ºå¤±è´¥ï¼Œæ”¶é›†è°ƒè¯•ä¿¡æ¯..."
        echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
        uname -a || echo "æ— æ³•è·å–ç³»ç»Ÿä¿¡æ¯"
        echo "=== ç¯å¢ƒå˜é‡ ==="
        env | grep -E "(RUST|CARGO|PATH)" || echo "æ— æ³•è·å–ç¯å¢ƒå˜é‡"
        echo "=== ç£ç›˜ç©ºé—´ ==="
        df -h || echo "æ— æ³•è·å–ç£ç›˜ä¿¡æ¯"
        echo "=== æ„å»ºæ—¥å¿— ==="
        if [ -f "src-tauri/target/${{ matrix.target }}/release/build/*/out/build.log" ]; then
          cat src-tauri/target/${{ matrix.target }}/release/build/*/out/build.log
        fi
      shell: bash

    - name: æŸ¥æ‰¾æ„å»ºæ–‡ä»¶
      run: |
        echo "æŸ¥æ‰¾æ„å»ºäº§ç‰©..."
        find src-tauri/target -name "machine-code-tool*" -type f || true
        ls -la src-tauri/target/${{ matrix.target }}/release/ || true
      shell: bash

    - name: å¤åˆ¶å¹¶é‡å‘½åæ„å»ºäº§ç‰©
      run: |
        mkdir -p upload
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          # Windows: å¤åˆ¶exeæ–‡ä»¶ï¼Œä¿æŒ.exeåç¼€
          cp src-tauri/target/${{ matrix.target }}/release/machine-code-tool.exe upload/${{ matrix.asset_name }}.exe
        elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          # Linux: æŸ¥æ‰¾å¹¶å¤åˆ¶AppImageæ–‡ä»¶
          echo "æŸ¥æ‰¾AppImageæ–‡ä»¶..."
          find src-tauri/target -name "*.AppImage" -type f
          APPIMAGE_FILE=$(find src-tauri/target -name "*.AppImage" -type f | head -1)
          if [ -n "$APPIMAGE_FILE" ]; then
            echo "æ‰¾åˆ°AppImage: $APPIMAGE_FILE"
            cp "$APPIMAGE_FILE" upload/${{ matrix.asset_name }}.AppImage
            chmod +x upload/${{ matrix.asset_name }}.AppImage
            echo "âœ… Linux AppImageæ–‡ä»¶å·²å‡†å¤‡å®Œæˆ"
          else
            echo "âŒ æœªæ‰¾åˆ°AppImageæ–‡ä»¶ï¼Œå°è¯•å¤åˆ¶æ™®é€šå¯æ‰§è¡Œæ–‡ä»¶"
            cp src-tauri/target/${{ matrix.target }}/release/machine-code-tool upload/${{ matrix.asset_name }}
            chmod +x upload/${{ matrix.asset_name }}
          fi
        else
          # macOS: å¤åˆ¶æ–‡ä»¶å¹¶æ·»åŠ æ‰§è¡Œæƒé™
          cp src-tauri/target/${{ matrix.target }}/release/machine-code-tool upload/${{ matrix.asset_name }}
          chmod +x upload/${{ matrix.asset_name }}
          echo "âœ… macOSæ–‡ä»¶å·²å‡†å¤‡å®Œæˆ"
        fi
        ls -la upload/
      shell: bash

    - name: ç”Ÿæˆå¹³å°è¯´æ˜æ–‡ä»¶
      run: |
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          echo "ğŸš€ æœºå™¨ç è·å–å·¥å…· - Windowsç‰ˆ" > upload/ä½¿ç”¨è¯´æ˜.txt
          echo "=========================" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "âœ… ä½¿ç”¨æ–¹æ³•:" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "åŒå‡» machine-code-tool-windows.exe è¿è¡Œå³å¯" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "ğŸ“‹ åŠŸèƒ½è¯´æ˜:" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- è·å–æœ¬æœºç¡¬ä»¶ä¿¡æ¯ï¼ˆMACåœ°å€ã€ä¸»æ¿åºåˆ—å·ç­‰ï¼‰" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- ç”Ÿæˆå”¯ä¸€æœºå™¨ç ç”¨äºè½¯ä»¶æˆæƒ" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "â“ å¸¸è§é—®é¢˜:" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- å¦‚æœæ€æ¯’è½¯ä»¶æ‹¦æˆªï¼Œè¯·æ·»åŠ ä¿¡ä»»" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- ç¨‹åºè¿è¡Œæ—¶è¯·å‹¿å…³é—­é»‘è‰²çª—å£" >> upload/ä½¿ç”¨è¯´æ˜.txt
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
          echo "ğŸ æœºå™¨ç è·å–å·¥å…· - macOSç‰ˆ" > upload/ä½¿ç”¨è¯´æ˜.txt
          echo "========================" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "âœ… ä½¿ç”¨æ–¹æ³•:" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "åŒå‡» machine-code-tool-macos æ–‡ä»¶è¿è¡Œå³å¯" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "ğŸ“‹ åŠŸèƒ½è¯´æ˜:" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- è·å–æœ¬æœºç¡¬ä»¶ä¿¡æ¯ï¼ˆMACåœ°å€ã€ä¸»æ¿åºåˆ—å·ç­‰ï¼‰" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- ç”Ÿæˆå”¯ä¸€æœºå™¨ç ç”¨äºè½¯ä»¶æˆæƒ" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "ğŸ”’ å®‰å…¨æç¤º:" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "å¦‚æç¤º'æ— æ³•éªŒè¯å¼€å‘è€…':" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- å³é”®ç‚¹å‡»æ–‡ä»¶ â†’ é€‰æ‹©'æ‰“å¼€'" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- æˆ–åˆ° ç³»ç»Ÿåå¥½è®¾ç½® â†’ å®‰å…¨æ€§ä¸éšç§ â†’ ç‚¹å‡»'ä»è¦æ‰“å¼€'" >> upload/ä½¿ç”¨è¯´æ˜.txt
        else
          echo "ğŸ§ æœºå™¨ç è·å–å·¥å…· - é“¶æ²³éº’éºŸç‰ˆ" > upload/ä½¿ç”¨è¯´æ˜.txt
          echo "============================" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "âœ… ä½¿ç”¨æ–¹æ³•:" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "æ–¹æ³•ä¸€ï¼ˆæ¨èï¼‰ï¼šåŒå‡»è¿è¡ŒAppImage" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "1. å³é”®ç‚¹å‡» machine-code-tool-kylin.AppImage æ–‡ä»¶" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "2. é€‰æ‹©"å±æ€§" â†’ "æƒé™" â†’ å‹¾é€‰"å…è®¸ä½œä¸ºç¨‹åºæ‰§è¡Œæ–‡ä»¶"" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "3. åŒå‡»æ–‡ä»¶å³å¯è¿è¡Œ" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "æ–¹æ³•äºŒï¼šç»ˆç«¯è¿è¡Œï¼ˆé€‚åˆæŠ€æœ¯äººå‘˜ï¼‰" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "1. æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥æ–‡ä»¶æ‰€åœ¨ç›®å½•" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "2. è¾“å…¥å‘½ä»¤: chmod +x machine-code-tool-kylin.AppImage" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "3. è¾“å…¥å‘½ä»¤: ./machine-code-tool-kylin.AppImage" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "ğŸ“‹ åŠŸèƒ½è¯´æ˜:" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- è·å–æœ¬æœºç¡¬ä»¶ä¿¡æ¯ï¼ˆMACåœ°å€ã€ä¸»æ¿åºåˆ—å·ç­‰ï¼‰" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- ç”Ÿæˆå”¯ä¸€æœºå™¨ç ç”¨äºè½¯ä»¶æˆæƒ" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "ğŸ’¡ æç¤º:" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- é€‚ç”¨äºé“¶æ²³éº’éºŸæ¡Œé¢æ“ä½œç³»ç»Ÿ" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- AppImageæ ¼å¼åŒ…å«æ‰€æœ‰ä¾èµ–ï¼Œæ— éœ€å®‰è£…ä»»ä½•åº“" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- ç¨‹åºå¯åŠ¨åä¼šæ˜¾ç¤ºæ“ä½œç•Œé¢" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "- å¦‚éœ€å…³é—­ç¨‹åºï¼Œç‚¹å‡»çª—å£å…³é—­æŒ‰é’®å³å¯" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "ğŸ” ä»€ä¹ˆæ˜¯AppImageï¼Ÿ" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "AppImageæ˜¯Linuxä¸‹çš„ä¾¿æºåº”ç”¨æ ¼å¼ï¼Œç±»ä¼¼Windowsçš„ç»¿è‰²è½¯ä»¶" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "åŒ…å«ç¨‹åºè¿è¡Œæ‰€éœ€çš„å…¨éƒ¨æ–‡ä»¶ï¼Œæ— éœ€å®‰è£…ï¼ŒåŒå‡»å³å¯è¿è¡Œ" >> upload/ä½¿ç”¨è¯´æ˜.txt
          echo "" >> upload/ä½¿ç”¨è¯´æ˜.txt
        fi
      shell: bash

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.asset_name }}
        path: upload/

  collect:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        pattern: machine-code-tool-*
        merge-multiple: true
      
    - name: æ•´ç†æ–‡ä»¶å¹¶æ·»åŠ æ­£ç¡®æ‰©å±•å
      run: |
        mkdir -p release
        
        echo "å½“å‰ç›®å½•æ–‡ä»¶:"
        ls -la
        
        # å¤„ç†æ‰€æœ‰ä¸‹è½½çš„æ–‡ä»¶
        for file in machine-code-tool-*; do
          if [ -f "$file" ]; then
            echo "å¤„ç†æ–‡ä»¶: $file"
            cp "$file" "release/$file"
            chmod +x "release/$file"
          fi
        done
        
        # macOSæ–‡ä»¶å·²ç»åœ¨ä¸Šé¢çš„å¾ªç¯ä¸­å¤„ç†äº†
        
        
        ls -la release/
      shell: bash
        
    - name: ä¸Šä¼ æœ€ç»ˆäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: all-platforms-${{ github.run_number }}
        path: release/
        
    - name: åˆ›å»ºRelease (ä»…æ ‡ç­¾æ¨é€æ—¶)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: release/*
        name: æœºå™¨ç è·å–å·¥å…· ${{ github.ref_name }}
        body: |
          ## ğŸš€ æœºå™¨ç è·å–å·¥å…· ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½é“¾æ¥
          - **Windows**: machine-code-tool-windows.exe
          - **macOS Intel**: machine-code-tool-macos-intel  
          - **macOS ARM**: machine-code-tool-macos-arm
          - **é“¶æ²³éº’éºŸ**: machine-code-tool-kylin
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - è·¨å¹³å°ç¡¬ä»¶ä¿¡æ¯è·å–
          - HTTP APIæœåŠ¡ (ç«¯å£18888)
          - å›¾å½¢ç”¨æˆ·ç•Œé¢
          - æˆæƒçŠ¶æ€ç®¡ç†
          
          ### ğŸ“‹ APIæ¥å£
          - `GET /api/machine-code` - è·å–æœºå™¨ç ä¿¡æ¯
          - `GET /api/auth-status` - æ£€æŸ¥æˆæƒçŠ¶æ€  
          - `POST /api/set-auth` - è®¾ç½®æˆæƒçŠ¶æ€
          - `GET /api/health` - å¥åº·æ£€æŸ¥
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}